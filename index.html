<!DOCTYPE html>

<html lang="en">
<head>
<title>WC2018 D3 Visualisation</title>

<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1" name="viewport"/>
<script src="https://cdn.tailwindcss.com"></script>
  <link rel="icon" type="image/x-icon" href="favicon.jpeg">
  <link rel="stylesheet" href="style.css" />  
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js"></script>
<script src="https://d3js.org/d3.v5.min.js"></script>
<script src="https://d3js.org/d3-geo-projection.v1.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js"></script>
</head>
<body class="bg-gradient-to-br from-gray-100 to-gray-200 min-h-screen overflow-y-auto font-sans">
<nav class="bg-gray-900 text-white px-4 py-3 shadow-md">
  <div class="max-w-7xl mx-auto flex flex-col md:flex-row justify-between items-center">
    <div class="text-xl font-medium tracking-wide">
      World Cup 2018 Visualisation using D3.js
    </div>
    <div class="flex space-x-4 text-sm mt-2 md:mt-0">
      <a href="index.html" class="hover:text-yellow-400 transition duration-150">Map</a>
      <a href="goalsByStadium.html" class="hover:text-yellow-400 transition duration-150">Pie Chart</a>
      <a href="knockOut.html" class="hover:text-yellow-400 transition duration-150">Scatter Plot</a>
      <a href="goalsByCountry.html" class="hover:text-yellow-400 transition duration-150">Goals by Country</a>
    </div>
  </div>
</nav>
<h1 class="text-center text-lg font-semibold mt-4">
  Interactive Map of 2018 FIFA World Cup Visualizations
</h1>  
<div class="w-full max-w-screen-xl mx-auto px-4 py-6 bg-gray-100" id="viz" style="overflow-x: auto; max-width: 100vw;">
  <div class="bg-white shadow-lg rounded-none p-0 m-0 w-full responsive-flex" >

  <div class="flex flex-col lg:flex-row justify-between items-start gap-6 w-full">
  <div class="w-full lg:w-3/4 p-4">
    
    <div class="overflow-x-auto w-full">
    <svg class="min-w-[900px] h-[500px] block border border-gray-300 rounded-lg"
       viewBox="0 0 850 800"
       preserveAspectRatio="xMidYMid meet"></svg>
    </div>
    <div class="flex flex-wrap justify-center gap-3 mt-6">
      <button onclick="wclocation()" class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1.5 rounded shadow text-sm">Countries Participated</button>
      <button onclick="winners()" class="bg-green-600 hover:bg-green-700 text-white px-3 py-1.5 rounded shadow text-sm">World Cup Winner</button>
      <button onclick="runners()" class="bg-orange-500 hover:bg-orange-600 text-white px-3 py-1.5 rounded shadow text-sm">World Cup Runner Up</button>
      <button onclick="highlightStadiums()" class="bg-pink-600 hover:bg-pink-700 text-white px-3 py-1.5 rounded shadow text-sm">Stadiums Used</button>
      <button onclick="topScoringMatches()" class="bg-indigo-600 hover:bg-indigo-700 text-white px-3 py-1.5 rounded shadow text-sm">Top Scoring Matches</button>
      <button onclick="matchTimeline()" class="bg-cyan-600 hover:bg-cyan-700 text-white px-3 py-1.5 rounded shadow text-sm">Match Timeline</button>
      <button onclick="goalsByCountry()" class="bg-yellow-500 hover:bg-yellow-600 text-white px-3 py-1.5 rounded shadow text-sm">Top 5 Goals scoring Countries</button>
      <button onclick="filterByStage()" class="bg-violet-600 hover:bg-violet-700 text-white px-3 py-1.5 rounded shadow text-sm">Stage Progress</button>
      <button onclick="hostHighlight()" class="bg-red-600 hover:bg-red-700 text-white px-3 py-1.5 rounded shadow text-sm">Host Country</button>
      <button onclick="headToHead()" class="bg-teal-600 hover:bg-teal-700 text-white px-3 py-1.5 rounded shadow text-sm">Head-to-Head</button>
    </div>
  </div>
  <div class="w-full lg:w-1/4 p-4">
    <div id="hello"
         class="bg-slate-100 border border-slate-300 rounded-lg shadow-md text-gray-800 text-sm p-6 h-full min-h-[600px] font-sans leading-relaxed"
         style="font-size: 0.85rem;">
    </div>
  </div>

        </div>

  </div>
</div>
<script>
let worldcupwinners = ["France"];
let worldcuplocations = [];
let worldcuprunners = ["Croatia"];
let stadiumData = [];
let matchData = [];
let hostCountry = "Russia";
let countriesGeoJSON; // 
let countryCSVData = [];  
let projection;

const PromiseWrapper = (xhr, d) => new Promise(resolve => xhr(d, (p) => resolve(p)));

Promise.all([
  d3.json("world.geojson"),
  d3.csv("World_cup_2018_country.csv"),
  d3.csv("WorldCup2018_Enriched.csv")
]).then(([geo, country, match]) => {
  countriesGeoJSON = geo;
  countryCSVData = country;
  matchData = match;
  createMap(countriesGeoJSON, countryCSVData, matchData); 
});


function createMap(countries, countryData, fullData) {
worldcuplocations = (countryData || []).map(d => d.Country || "");  
stadiumData = fullData.filter(d => d.Latitude && d.Longitude && !isNaN(d.Latitude) && !isNaN(d.Longitude));
matchData = fullData;
countriesGeoJSON = countries;
  
const svg = d3.select("svg");
const bounds = svg.node().getBoundingClientRect();
const width = bounds.width;
const height = bounds.height;  
 
projection = d3.geoNaturalEarth1()
  .center([30, 30])
  .scale(width / 3.25)
  .translate([width / 1.95, height / 1.95]);

const path = d3.geoPath().projection(projection);

svg.selectAll("path")
  .data(countries.features)
  .enter()
  .append("path")
  .attr("d", path)
  .attr("class", "countries")
  .style("fill", "#3F6E8D")
  .style("stroke", "white");

  
}

function resetMap() {
  d3.select("svg").selectAll(".countries")
    .style("fill", "#3F6E8D");
  d3.select("svg").selectAll(".stadium").remove();
}

function updateCard(content) {
  const info = document.getElementById("hello");
  info.innerHTML = content;
  info.className = "bg-slate-100 border border-slate-300 rounded-lg shadow-md text-gray-800 text-sm p-6 h-full min-h-[650px] font-sans leading-relaxed";
  info.style.fontSize = "0.85rem";
  info.querySelectorAll("strong").forEach(el => {
    el.style.color = "#1f2937"; // Tailwind gray-800
    el.style.fontWeight = "600"; // same as font-semibold
  });
}


function wclocation() {
  resetMap();
  d3.select("svg").selectAll(".countries")
    .filter(d => worldcuplocations.includes(d.properties.name))
    .style("fill", "#3b82f6");
  updateCard("<strong>Countries Participated:</strong><br><br>" + worldcuplocations.join(", "));
}

function winners() {
  resetMap();
  d3.select("svg").selectAll(".countries")
    .filter(d => worldcupwinners.includes(d.properties.name))
    .style("fill", "#10b981");
  updateCard("World Cup Winner is <strong>France</strong><br><br>France won the final match against Croatia with a score of <strong>4 - 2</strong>.");
}

function runners() {
  resetMap();
  d3.select("svg").selectAll(".countries")
    .filter(d => worldcuprunners.includes(d.properties.name))
    .style("fill", "#f59e0b");
  updateCard("World Cup Runner Up is <strong>Croatia</strong><br><br>Croatia reached the final and lost to France with a score of <strong>2 - 4</strong>.");
}

function highlightStadiums() {
  resetMap();

  const svg = d3.select("svg");
  svg.selectAll(".stadium").remove();

  const validStadiums = stadiumData.filter(d =>
    d.Stadium && d.City &&
    !isNaN(+d.Latitude) && !isNaN(+d.Longitude)
  );

  const uniqueMap = new Map();
  validStadiums.forEach(d => {
    if (!uniqueMap.has(d.Stadium)) {
      uniqueMap.set(d.Stadium, d); // use first unique occurrence
    }
  });

  const uniqueStadiums = Array.from(uniqueMap.values());

  svg.selectAll(".stadium")
    .data(uniqueStadiums)
    .enter()
    .append("circle")
    .attr("class", "stadium")
    .attr("cx", d => projection([+d.Longitude, +d.Latitude])[0])
    .attr("cy", d => projection([+d.Longitude, +d.Latitude])[1])
    .attr("r", 5)
    .style("fill", "#ec4899")
    .style("stroke", "#000");

  const stadiumList = uniqueStadiums.map(d =>
    `${d.Stadium} (${d.City}, Russia)`
  );

  updateCard("<strong>Stadiums Used:</strong><br><br>" + stadiumList.join("<br>"));
}


function topScoringMatches() {
  resetMap();
  const topMatches = matchData
    .map(d => ({
      match: `${d.Home} vs ${d.Away}`,
      score: `${d.Home_goals} - ${d.Away_goals}`,
      totalGoals: +d.Home_goals + +d.Away_goals
    }))
    .sort((a, b) => b.totalGoals - a.totalGoals)
    .slice(0, 5)
    .map(m => `${m.match} â€” ${m.score} (${m.totalGoals} goals)`);

  updateCard("<strong>Top 5 Highest Scoring Matches:</strong><br><br>" + topMatches.join("<br>"));
}


function matchTimeline() {
  resetMap();

  const goalsPerDay = {};

  matchData.forEach(d => {
    const date = d.Date;
    const goals = (+d.Home_goals || 0) + (+d.Away_goals || 0);
    goalsPerDay[date] = (goalsPerDay[date] || 0) + goals;
  });

  const timeline = Object.entries(goalsPerDay)
    .sort((a, b) => new Date(a[0].split("-").reverse().join("-")) - new Date(b[0].split("-").reverse().join("-")))
    .map(([date, goals]) => `${date}: ${goals} goals`);

  updateCard("<strong>Goals per Match Day:</strong><br><br>" + timeline.join("<br>"));
}

function goalsByCountry() {
  resetMap();
  const goalCount = {};
  matchData.forEach(d => {
    goalCount[d.Team1] = (goalCount[d.Team1] || 0) + (+d.Goals1 || 0);
    goalCount[d.Team2] = (goalCount[d.Team2] || 0) + (+d.Goals2 || 0);
  });
  const topTeams = Object.entries(goalCount)
    .sort((a, b) => b[1] - a[1])
    .slice(0, 5)
    .map(([team, goals]) => `${team}: ${goals} goals`);
  updateCard("<strong>Top Goal Scoring Teams:</strong><br><br>" + topTeams.join("<br>"));
}

function filterByStage() {
  resetMap();

  const stageRank = {
    "Group": 1,
    "Round of 16": 2,
    "Quarter Finals": 3,
    "Semi Finals": 4,
    "Third Place": 5,
    "Final": 6
  };

  const stageColor = {
    1: "#dc2626",  // Red â€“ Group
    2: "#f97316",  // Orange â€“ Round of 16
    3: "#8b5cf6",  // Violet â€“ Quarter Finals
    4: "#06b6d4",  // Cyan â€“ Semi Finals (reserved)
    5: "#eab308",  // Yellow â€“ Third Place
    6: "#16a34a"   // Green â€“ Final
  };

  const nameMap = {
    "United Kingdom": "England",
    "Republic of Serbia": "Serbia"
  };

  const maxStagePerCountry = {};

  matchData.forEach(d => {
    const raw = d.Stage || "Group";
    let stage = "Group";

    if (raw.includes("Group")) stage = "Group";
    else if (raw.includes("Last")) stage = "Round of 16";
    else if (raw.includes("QFinal")) stage = "Quarter Finals";
    else if (raw.includes("SFinal")) stage = "Semi Finals";
    else if (raw.includes("Third")) stage = "Third Place";
    else if (raw === "Final") stage = "Final";

    const rank = stageRank[stage];

    [d.Home, d.Away].forEach(team => {
      if (!maxStagePerCountry[team] || rank > maxStagePerCountry[team]) {
        maxStagePerCountry[team] = rank;
      }
    });
  });

  // Apply colors to map
  d3.select("svg").selectAll(".countries")
    .style("fill", d => {
      const team = nameMap[d.properties.name] || d.properties.name;
      const rank = maxStagePerCountry[team];
      return stageColor[rank] || "#3F6E8D";
    });
  
  const grouped = {
    "Group": [],
    "Round of 16": [],
    "Quarter Finals": [],
    "Semi Finals": [],
    "Third Place": [],
    "Final": []
  };

  Object.entries(maxStagePerCountry).forEach(([country, rank]) => {
    const stage = Object.keys(stageRank).find(key => stageRank[key] === rank);
    if (stage) grouped[stage].push(country);
  });

  let html = `<strong>ðŸŽ¨ World Cup 2018 Stage Progress Color Key</strong><br><br>`;

  html += `ðŸ”´ <strong>Red</strong> â†’ Group Stage Only<br><em>Teams that played in the Group Stage but did not qualify to Round of 16</em><br><br>`;
  html += grouped["Group"].sort().join(", ") + "<br><br>";

  html += `ðŸŸ  <strong>Orange</strong> â†’ Reached Round of 16<br><em>Qualified from Group but eliminated in Round of 16</em><br><br>`;
  html += grouped["Round of 16"].sort().join(", ") + "<br><br>";

  html += `ðŸŸ£ <strong>Violet</strong> â†’ Reached Quarter Finals<br><em>Advanced past Round of 16 but eliminated in Quarter Finals</em><br><br>`;
  html += grouped["Quarter Finals"].sort().join(", ") + "<br><br>";

  html += `ðŸŸ¡ <strong>Yellow</strong> â†’ Reached Third Place Match<br><em>Played in Third Place match (did not reach Final)</em><br><br>`;
  html += grouped["Third Place"].sort().join(", ") + "<br><br>";

  html += `ðŸŸ¢ <strong>Green</strong> â†’ Reached Final<br><em>Played in the Final</em><br>`;
  html += grouped["Final"].sort().join(", ") + "<br><br>";

  updateCard(html);
}


function goalsByCountry() {
  resetMap();

  const goalCount = {};

  matchData.forEach(d => {
    goalCount[d.Home] = (goalCount[d.Home] || 0) + (+d.Home_goals || 0);
    goalCount[d.Away] = (goalCount[d.Away] || 0) + (+d.Away_goals || 0);
  });

  const topTeams = Object.entries(goalCount)
    .sort((a, b) => b[1] - a[1])
    .slice(0, 5)
    .map(([team, goals]) => `${team}: ${goals} goals`);

  updateCard("<strong>Top 5 Goal Scoring Countries:</strong><br><br>" + topTeams.join("<br>"));
}

function hostHighlight() {
  resetMap();
  d3.select("svg").selectAll(".countries")
    .filter(d => d.properties.name === hostCountry)
    .style("fill", "#f43f5e")
    .style("stroke", "black");
  updateCard("<strong>Host Country:</strong><br><br>Russia hosted the FIFA World Cup 2018.");
}

function headToHead() {
  resetMap();

  const matchups = matchData.map(d =>
    `${d.Home} ${d.Home_goals} - ${d.Away_goals} ${d.Away}`
  );

  updateCard("<strong>All Head-to-Head Match Results:</strong><br><br>" + matchups.join("<br>"));
}
  
//window.addEventListener("resize", () => {
//  d3.select("svg").selectAll("*").remove();
//  createMap(countriesGeoJSON, worldcuplocations, matchData);
//});  

window.addEventListener("resize", () => {
  if (!countriesGeoJSON || !countryCSVData || !matchData) return; // âœ… guard clause
  d3.select("svg").selectAll("*").remove();
  createMap(countriesGeoJSON, countryCSVData, matchData); // âœ… correct dataset
});  

</script>
</body>
</html>