<!DOCTYPE html>

<html lang="en">
<head>
<title>WC2018 D3 Visualisation</title>

<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1" name="viewport"/>
<script src="https://cdn.tailwindcss.com"></script>
  <link rel="icon" type="image/x-icon" href="favicon.jpeg">
  <link rel="stylesheet" href="style.css" />  
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js"></script>
<script src="https://d3js.org/d3.v5.min.js"></script>
<script src="https://d3js.org/d3-geo-projection.v1.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js"></script>
</head>
<body class="bg-gradient-to-br from-gray-100 to-gray-200 min-h-screen overflow-y-auto font-sans">
<nav class="bg-gray-900 text-white px-4 py-3 shadow-md">
  <div class="max-w-7xl mx-auto flex flex-col md:flex-row justify-between items-center">
    <div class="text-xl font-medium tracking-wide">
      World Cup 2018 Visualisation using D3.js
    </div>
    <div class="flex space-x-4 text-sm mt-2 md:mt-0">
      <a href="index.html" class="hover:text-yellow-400 transition duration-150">Map</a>
      <a href="goalsByStadium.html" class="hover:text-yellow-400 transition duration-150">Pie Chart</a>
      <a href="knockOut.html" class="hover:text-yellow-400 transition duration-150">Scatter Plot</a>
      <a href="goalsByCountry.html" class="hover:text-yellow-400 transition duration-150">Goals by Country</a>
    </div>
  </div>
</nav>
<h1 class="text-center text-lg font-semibold mt-4">
  Interactive Map of 2018 FIFA World Cup Visualizations
</h1>  
<div class="w-full max-w-screen-xl mx-auto px-4 py-6 bg-gray-100" id="viz" style="overflow-x: auto; max-width: 100vw;">
  <div class="bg-white shadow-lg rounded-none p-0 m-0 w-full responsive-flex" >

  <div class="flex flex-col lg:flex-row justify-between items-start gap-6 w-full">
  <div class="w-full lg:w-3/4 p-4">
    
    <div class="overflow-x-auto w-full" style="transform-style: preserve-3d;">
    <svg class="min-w-[900px] h-[500px] block border border-gray-300 rounded-lg"
       viewBox="0 0 850 800"
       preserveAspectRatio="xMidYMid meet" style="will-change: opacity, transform; transform: translateZ(0); backface-visibility: hidden; contain: strict;"></svg>
    </div>
    <div class="flex flex-wrap justify-center gap-3 mt-6">
      <button onclick="wclocation()" class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1.5 rounded shadow text-sm">Countries Participated</button>
      <button onclick="winners()" class="bg-green-600 hover:bg-green-700 text-white px-3 py-1.5 rounded shadow text-sm">World Cup Winner</button>
      <button onclick="runners()" class="bg-orange-500 hover:bg-orange-600 text-white px-3 py-1.5 rounded shadow text-sm">World Cup Runner Up</button>
      <button onclick="highlightStadiums()" class="bg-pink-600 hover:bg-pink-700 text-white px-3 py-1.5 rounded shadow text-sm">Stadiums Used</button>
      <button onclick="topScoringMatches()" class="bg-indigo-600 hover:bg-indigo-700 text-white px-3 py-1.5 rounded shadow text-sm">Top Scoring Matches</button>
      <button onclick="matchTimeline()" class="bg-cyan-600 hover:bg-cyan-700 text-white px-3 py-1.5 rounded shadow text-sm">Match Timeline</button>
      <button onclick="goalsByCountry()" class="bg-yellow-500 hover:bg-yellow-600 text-white px-3 py-1.5 rounded shadow text-sm">Top 5 Goals scoring Countries</button>
      <button onclick="filterByStage()" class="bg-violet-600 hover:bg-violet-700 text-white px-3 py-1.5 rounded shadow text-sm">Stage Progress</button>
      <button onclick="hostHighlight()" class="bg-red-600 hover:bg-red-700 text-white px-3 py-1.5 rounded shadow text-sm">Host Country</button>
      <button onclick="headToHead()" class="bg-teal-600 hover:bg-teal-700 text-white px-3 py-1.5 rounded shadow text-sm">Head-to-Head</button>
    </div>
  </div>
  <div class="w-full lg:w-1/4 p-4">
    <div id="hello"
         class="bg-slate-100 border border-slate-300 rounded-lg shadow-md text-gray-800 text-sm p-6 h-full min-h-[600px] font-sans leading-relaxed"
         style="font-size: 0.85rem;">
    </div>
  </div>

        </div>

  </div>
</div>
<script>
let worldcupwinners = ["France"];
let worldcuplocations = [];
let worldcuprunners = ["Croatia"];
let stadiumData = [];
let matchData = [];
let hostCountry = "Russia";
let countriesGeoJSON;
let countryCSVData = [];
let projection;

let currentHighlightFn = null; // ✅ store last action

const PromiseWrapper = (xhr, d) => new Promise(resolve => xhr(d, (p) => resolve(p)));

Promise.all([
  d3.json("world.geojson"),
  d3.csv("World_cup_2018_country.csv"),
  d3.csv("WorldCup2018_Enriched.csv")
]).then(([geo, country, match]) => {
  countriesGeoJSON = geo;
  countryCSVData = country;
  matchData = match;
  createMap(countriesGeoJSON, countryCSVData, matchData);
});

function createMap(countries, countryData, fullData) {
  worldcuplocations = (countryData || []).map(d => d.Country || "");
  stadiumData = fullData.filter(d => d.Latitude && d.Longitude && !isNaN(d.Latitude) && !isNaN(d.Longitude));
  matchData = fullData;

  const svg = d3.select("svg");
  const bounds = svg.node().getBoundingClientRect();
  const width = bounds.width;
  const height = bounds.height;

  projection = d3.geoNaturalEarth1()
    .center([30, 30])
    .scale(width / 3.25)
    .translate([width / 1.95, height / 1.95]);

  const path = d3.geoPath().projection(projection);

  svg.selectAll("path")
    .data(countries.features)
    .enter()
    .append("path")
    .attr("d", path)
    .attr("class", "countries")
    .attr("fill", "#3F6E8D")
    .attr("stroke", "white");

  if (typeof currentHighlightFn === "function") {
    currentHighlightFn(); // ✅ restore highlight after re-render
  }
}

function resetMap() {
  d3.select("svg").selectAll(".countries").attr("fill", "#3F6E8D");
  d3.select("svg").selectAll(".stadium").remove();
}

function updateCard(content) {
  const info = document.getElementById("hello");
  info.innerHTML = content;
  info.className = "bg-slate-100 border border-slate-300 rounded-lg shadow-md text-gray-800 text-sm p-6 h-full min-h-[650px] font-sans leading-relaxed";
  info.style.fontSize = "0.85rem";
  info.querySelectorAll("strong").forEach(el => {
    el.style.color = "#1f2937";
    el.style.fontWeight = "600";
  });
}

function wclocation() {
  resetMap();
  d3.select("svg").selectAll(".countries")
    .filter(d => worldcuplocations.includes(d.properties.name))
    .attr("fill", "#3b82f6");
  updateCard("<strong>Countries Participated:</strong><br><br>" + worldcuplocations.join(", "));
  currentHighlightFn = wclocation; // ✅
}

function winners() {
  resetMap();
  d3.select("svg").selectAll(".countries")
    .filter(d => worldcupwinners.includes(d.properties.name))
    .attr("fill", "#10b981");
  updateCard("World Cup Winner is <strong>France</strong><br><br>France won the final match against Croatia with a score of <strong>4 - 2</strong>.");
  currentHighlightFn = winners; // ✅
}

function runners() {
  resetMap();
  d3.select("svg").selectAll(".countries")
    .filter(d => worldcuprunners.includes(d.properties.name))
    .attr("fill", "#f59e0b");
  updateCard("World Cup Runner Up is <strong>Croatia</strong><br><br>Croatia reached the final and lost to France with a score of <strong>2 - 4</strong>.");
  currentHighlightFn = runners; // ✅
}

function highlightStadiums() {
  resetMap();
  const svg = d3.select("svg");
  svg.selectAll(".stadium").remove();

  const validStadiums = stadiumData.filter(d =>
    d.Stadium && d.City &&
    !isNaN(+d.Latitude) && !isNaN(+d.Longitude)
  );

  const uniqueMap = new Map();
  validStadiums.forEach(d => {
    if (!uniqueMap.has(d.Stadium)) {
      uniqueMap.set(d.Stadium, d);
    }
  });

  const uniqueStadiums = Array.from(uniqueMap.values());

  svg.selectAll(".stadium")
    .data(uniqueStadiums)
    .enter()
    .append("circle")
    .attr("class", "stadium")
    .attr("cx", d => projection([+d.Longitude, +d.Latitude])[0])
    .attr("cy", d => projection([+d.Longitude, +d.Latitude])[1])
    .attr("r", 5)
    .attr("fill", "#ec4899")
    .attr("stroke", "#000");

  const stadiumList = uniqueStadiums.map(d =>
    `${d.Stadium} (${d.City}, Russia)`
  );

  updateCard("<strong>Stadiums Used:</strong><br><br>" + stadiumList.join("<br>"));
  currentHighlightFn = highlightStadiums; // ✅
}

function hostHighlight() {
  resetMap();
  d3.select("svg").selectAll(".countries")
    .filter(d => d.properties.name === hostCountry)
    .attr("fill", "#f43f5e")
    .attr("stroke", "black");
  updateCard("<strong>Host Country:</strong><br><br>Russia hosted the FIFA World Cup 2018.");
  currentHighlightFn = hostHighlight; // ✅
}

// ✅ REDRAW on resize
window.addEventListener("resize", () => {
  if (!countriesGeoJSON || !countryCSVData || !matchData) return;
  d3.select("svg").selectAll("*").remove();
  createMap(countriesGeoJSON, countryCSVData, matchData);
});

// ✅ RESTORE HIGHLIGHT ON SCROLL (for mobile)
window.addEventListener("scroll", () => {
  if (typeof currentHighlightFn === "function") {
    currentHighlightFn();
  }
});

// ✅ RESTORE ON ORIENTATION CHANGE
window.addEventListener("orientationchange", () => {
  setTimeout(() => {
    if (typeof currentHighlightFn === "function") {
      currentHighlightFn();
    }
  }, 300);
});
</script>
</body>
</html>
